---
layout: post
title: 'Data Exploration (with HRA Data)'
date: 2017-01-26
author: Yin-Ting 
categories: [Visualization]
tags: [ggplot2, table]
---
### Ideas
After knowing the background and the goal of [HRA Data](https://choux130.github.io/myblog//data/2017/01/25/HRA-Data.html), I know this data is about a binary response variable and many numerical and categorical explanatory variables. To get more insights of the dataset, there are two parts in my data exploration process. 

1. the relationship between the response variable _("Whether the employee has left")_ and all the other explanatory variables. 
2. the relationship between all the explanatory variables. 

And, the relationship here is nothing complicated but some graphs, tables or some meaningful values. Briefly, it could be like this: 

------------------------------------------------------------------------------------
   Variables             Numerical                          Categorical         
----------------- --------------------------------- --------------------------------
  **Numerical**    - Scatter Plot  <br />            - Side by Side Box Plot <br />   
                   - Correlation Coefficient         - Overlapping Histograms <br />  
                                                     - Summary Table              

 **Categorical**   - Side by Side Box Plot <br />    - Contingency Table           
                   - Overlapping Histograms <br />                               
                   - Summary Table                                          
-------------------------------------------------------------------------------------

***

### Data Cleaning 
Before doing data exploration, we need to make sure that the data is clean and ready to be used. 

1. Import raw data and keep it pure. 
```{r}
#########################
#### Import Raw Data ####
#########################
dat=read.csv("https://choux130.github.io/myblog/data/HR_analytics.csv", header=TRUE)
data=dat # keep raw data pure
```

{:start="2"} 
2. Rename the variables and recorder the columns for convenience.

```{r}
##############################
#### Rename the variables ####
##############################
names(data)=c("satisf_level","last_eval","num_proj",
              "ave_mon_hrs","time_spend","work_accid",
              "left_or_not","promo_last_5yrs","department",
              "salary")

##########################
#### Reorder the data ####
##########################
data=data[,c(1:6,8:10,7)]
```

{:start="3"}
3. Correct all the variables' attributes.

```{r}
#######################################
#### Correct variables' attributes ####
#######################################
data$work_accid=as.factor(data$work_accid)
data$promo_last_5yrs=as.factor(data$promo_last_5yrs)
data$left_or_not=as.factor(data$left_or_not)
str(data) 
```

{:start="4"}
4. Checking for missing data.

```{r}
####################
#### Finding NA ####
####################
which(is.na(data), arr.ind=TRUE) #the indices of NA values
```

***

## Data Exploration (Quantitative Explanotary Variables vs. Qualitative Binary Response Variable)
### R functions 
#### Table
```{r message = FALSE}
t_bygroup=function(d, x, y, n){
  # an elegant way to install a missing package
  if (!require("plyr")) install.packages("plyr")
    t <- ddply(d, y, .fun = function(dd){
               c(Mean = mean(dd[,x],na.rm=TRUE),
               Sd = sd(dd[,x],na.rm=TRUE),
               min=min(dd[,x]), 
               Q1=quantile(dd[,x],0.25),
               Median=quantile(dd[,x],0.5),
               Q3=quantile(dd[,x],0.75), 
               Max=max(dd[,x])) })
  return(t)
}
```
#### Histogram
```{r message = FALSE}
hist_bygroup=function(d,xx,yy,name){
    if (!require("ggplot2")) install.packages("ggplot2")
    ggplot(d, aes_string(x=xx, color=yy, fill=yy))+ 
    geom_histogram(aes(y=..density..), alpha=0.5, 
                 position="identity")+
    geom_density(alpha=.3)+
    ggtitle(name)  
}
```

#### Box plot
```{r message = FALSE}
box_bygroup=function(d,xx,yy,name){
    if (!require("ggplot2")) install.packages("ggplot2")
    ggplot(d, aes_string(x=yy, y=xx, fill=yy)) + 
    geom_boxplot()+
    ggtitle(name) 
}
```

### Employee satisfaction level
```{r message = FALSE, fig.width=10, fig.height=5}
# Table
t_bygroup(d=data, x="satisf_level", y='left_or_not', n=2)

if (!require("Rmisc")) install.packages("Rmisc") # Arrangement for multiple ggplots
# Histogram
hist_sat=hist_bygroup(d=data, xx="satisf_level", yy="left_or_not",
               "Histogram for satisf_level")
# Box plot
box_sat=box_bygroup(d=data, xx="satisf_level", yy="left_or_not",
               "Boxplot for satisf_level")
multiplot(plotlist = list(hist_sat,box_sat), cols = 2) 
```

### Last evaluation
```{r fig.width=10, fig.height=5}
# Table
t_bygroup(data, "last_eval", "left_or_not")

# Histogram
hist_eval=hist_bygroup(d=data, xx="last_eval", yy="left_or_not",
               "Histogram for last_eval")
# Box plot
box_eval=box_bygroup(d=data, xx="last_eval", yy="left_or_not",
               "Boxplot for last_eval")
multiplot(plotlist = list(hist_eval,box_eval), cols = 2) 

```

### Number of projects
```{r fig.width=10, fig.height=5}
# Table
t_bygroup(data, "num_proj", "left_or_not")
# Histogram
hist_proj=hist_bygroup(d=data, xx="num_proj", yy="left_or_not",
               "Histogram for num_proj")
# Box plot
box_proj=box_bygroup(d=data, xx="num_proj", yy="left_or_not",
               "Boxplot for num_proj")
multiplot(plotlist = list(hist_proj,box_proj), cols = 2) 

```

### Average monthly hours
```{r fig.width=10, fig.height=5}
# Table
t_bygroup(data, "ave_mon_hrs", "left_or_not")
# Histogram
hist_hrs=hist_bygroup(d=data, xx="ave_mon_hrs", 
                       yy="left_or_not",
                       "Histogram for ave_mon_hrs")
# Box plot
box_hrs=box_bygroup(d=data, xx="ave_mon_hrs",
                     yy="left_or_not",
                     "Boxplot for ave_mon_hrs")
multiplot(plotlist = list(hist_hrs,box_hrs), cols = 2) 
```

### Time spent at the company
```{r fig.width=10, fig.height=5}
# Table
t_bygroup(data, "time_spend", "left_or_not")
# Histogram
hist_time=hist_bygroup(d=data, xx="time_spend", 
                       yy="left_or_not",
                       "Histogram for time_spend")
# Box plot
box_time=box_bygroup(d=data, xx="time_spend",
                     yy="left_or_not",
                     "Boxplot for time_spend")
multiplot(plotlist = list(hist_time,box_time), cols = 2) 
```

```{r}
if (!require("GGally")) install.packages("GGally")
#ggpairs(data=data, columns = c(1:10), 
#        mapping=ggplot2::aes(colour = left_or_not,  alpha=0.9))
#ggpairs(data=data, columns = c(1,2,4,5,3,10), 
#        mapping=ggplot2::aes(colour = left_or_not,  alpha=0.8))
#ggpairs(data=data, columns = c(6:9,10),
#        mapping=ggplot2::aes(colour = left_or_not,  alpha=0.8))
```

***

## Data Exploration (Qualitative Explanotary Variables vs. Qualitative Binary Response Variable)
### Whether they have had a work accident 
### Whether they have had a promotion in the last 5 years
### Department
### Salary
```{r}
# Use list techniques to create all the tables at once.  
# Count
list_xtab=
  lapply(data[,c("work_accid","promo_last_5yrs",
                 "department","salary")], 
  function(x) xtabs(~ x + data$left_or_not))
(list_xtab_sum=lapply(list_xtab,addmargins))

# Proportion
list_prop=lapply(list_xtab, prop.table)
list_prop=lapply(list_prop,round,3)
(list_prop_sum=lapply(list_prop, addmargins))
```

```{r message = FALSE}
if (!require("gmodels")) install.packages("gmodels")
CrossTable(x = data$work_accid, y = data$left_or_not, 
           digits=3, max.width = 5, prop.r=TRUE,
           prop.chisq=FALSE, prop.c=TRUE,format=c("SPSS"))
```
```{r message = FALSE}
CrossTable(x = data$promo_last_5yrs, y = data$left_or_not, 
           digits=3, max.width = 5, prop.r=TRUE,
           prop.chisq=FALSE, prop.c=TRUE,format=c("SPSS"))
```
```{r message = FALSE}
CrossTable(x = data$department, y = data$left_or_not, 
           digits=3, max.width = 5, prop.r=TRUE,
           prop.chisq=FALSE, prop.c=TRUE,format=c("SPSS"))
```
```{r message = FALSE}
CrossTable(x = data$salary, y = data$left_or_not, 
           digits=3, max.width = 5, prop.r=TRUE,
           prop.chisq=FALSE, prop.c=TRUE,format=c("SPSS"))

```

*** 
